<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì‹¤ì‹œê°„ ë­í‚¹ & ê²Œì‹œíŒ & ì²­ìš´ìš°ì²´í†µ</title>
  <style>
  * { box-sizing: border-box; }

  body {
    margin: 0;
    font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: radial-gradient(circle at top, #e0f2fe 0%, #f9fafb 45%, #ffffff 100%);
    color: #0f172a;
  }

  /* ìƒë‹¨ í—¤ë” */

  header {
    padding: 12px 24px 16px;
    border-bottom: 1px solid #dbeafe;
    background: rgba(255,255,255,0.95);
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: 16px;
    position: sticky;
    top: 0;
    z-index: 20;
    backdrop-filter: blur(10px);
  }

  .logo {
    padding: 8px 18px;
    border-radius: 999px;
    background: linear-gradient(to right, #3b82f6, #38bdf8);
    color: #f9fafb;
    font-weight: 800;
    font-size: 20px;
    box-shadow: 0 4px 10px rgba(37,99,235,0.4);
  }

  .subtitle {
    font-size: 12px;
    color: #4b5563;
    margin-top: 4px;
  }

  /* ìƒë‹¨ íƒ­ */

  .nav-tabs {
    display: flex;
    gap: 8px;
    align-items: center;
  }

  .nav-btn {
    font-size: 12px;
    padding: 6px 14px;
    border-radius: 999px;
    border: 1px solid #bfdbfe;
    background: #eff6ff;
    color: #1d4ed8;
    cursor: pointer;
    white-space: nowrap;
    box-shadow: 0 2px 0 rgba(148,163,184,0.6);
    transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
  }

  .nav-btn:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(148,163,184,0.6);
  }

  .nav-btn.active {
    border-color: #2563eb;
    background: linear-gradient(to right, #bfdbfe, #dbeafe);
    color: #1f2937;
  }

  /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */

  main {
    max-width: 1080px;
    margin: 0 auto;
    padding: 16px;
  }

  .vote-layout {
    display: grid;
    grid-template-columns: 260px 1fr 260px;
    gap: 16px;
  }

  @media (max-width: 900px) {
    .vote-layout {
      grid-template-columns: 1fr;
    }
  }

  /* ê³µí†µ ì¹´ë“œ / íŒ¨ë„ */

  .panel {
    background: #ffffff;
    border-radius: 18px;
    border: 1px solid #dbeafe;
    padding: 12px 12px 16px;
    font-size: 14px;
    box-shadow: 0 12px 25px rgba(15,23,42,0.07);
  }

  .panel-title {
    font-size: 15px;
    font-weight: 700;
    margin-bottom: 8px;
    color: #1d4ed8;
    display: flex;
    align-items: center;
    gap: 4px;
  }

  .panel-title::before {
    content: "ğŸŒ¸";
    font-size: 13px;
  }

  /* íˆ¬í‘œ ì§ˆë¬¸ ëª©ë¡ */

  .question-list {
    display: flex;
    flex-direction: column;
    gap: 6px;
    max-height: 360px;
    overflow-y: auto;
  }

  .question-item {
    border-radius: 12px;
    padding: 8px 10px;
    border: 1px solid #e5e7eb;
    background: #f3f4ff;
    cursor: pointer;
    font-size: 13px;
    line-height: 1.4;
    transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease, border-color 0.08s ease;
  }

  .question-item small {
    display: block;
    color: #6b7280;
    font-size: 11px;
    margin-top: 2px;
  }

  .question-item:hover {
    transform: translateY(-1px);
    box-shadow: 0 4px 10px rgba(148,163,184,0.4);
    border-color: #bfdbfe;
  }

  .question-item.active {
    border-color: #2563eb;
    background: linear-gradient(to right, #e0f2fe, #eff6ff);
  }

  /* ì¤‘ì•™ ì¹´ë“œ (íˆ¬í‘œ ì§ˆë¬¸) */

  .card {
    background: #ffffff;
    border-radius: 22px;
    border: 1px solid #dbeafe;
    padding: 20px 18px 18px;
    min-height: 260px;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
    box-shadow: 0 16px 30px rgba(15,23,42,0.08);
  }

  .card-tag {
    font-size: 11px;
    padding: 4px 8px;
    border-radius: 999px;
    border: 1px solid #bfdbfe;
    display: inline-block;
    margin-bottom: 6px;
    color: #1d4ed8;
    background: #eff6ff;
  }

  .card-title {
    font-size: 22px;
    font-weight: 800;
    margin-bottom: 6px;
    color: #0f172a;
  }

  .card-desc {
    font-size: 13px;
    color: #4b5563;
    margin-bottom: 16px;
  }

  .card-meta {
    font-size: 12px;
    color: #6b7280;
    margin-bottom: 6px;
  }

  .vote-form {
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  .vote-form input {
    flex: 1;
    min-width: 160px;
    padding: 8px 10px;
    border-radius: 999px;
    border: 1px solid #cbd5f5;
    background: #ffffff;
    color: #0f172a;
    font-size: 13px;
  }

  .vote-form input:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 2px rgba(37,99,235,0.15);
  }

  .vote-form button {
    padding: 8px 14px;
    border-radius: 999px;
    border: none;
    background: linear-gradient(to right, #3b82f6, #f2fff7);
    color: #f9fafb;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    white-space: nowrap;
    box-shadow: 0 4px 10px rgba(169, 248, 255, 0.45);
    transition: transform 0.08s ease, box-shadow 0.08s ease;
  }

  .vote-form button:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 14px rgba(145, 222, 255, 0.6);
  }

  /* ì´ì „ ì§ˆë¬¸ ë²„íŠ¼ (ê°™ì€ ìŠ¤íƒ€ì¼ ì¬ì‚¬ìš©) */

  .next-question-btn {
    margin-top: 10px;
    padding: 6px 12px;
    border-radius: 999px;
    border: 1px solid #bfdbfe;
    background: #eff6ff;
    color: #1d4ed8;
    font-size: 12px;
    cursor: pointer;
    align-self: flex-end;
    box-shadow: 0 2px 4px rgba(148,163,184,0.5);
    transition: transform 0.08s ease, box-shadow 0.08s ease, background 0.08s ease;
  }

  .next-question-btn:hover {
    background: #e0f2fe;
    transform: translateY(-1px);
    box-shadow: 0 4px 8px rgba(148,163,184,0.7);
  }

  /* ë­í‚¹ ì˜ì—­ */

  .ranking-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
  }

  .ranking-sub {
    font-size: 11px;
    color: #6b7280;
  }

  .ranking-list {
    margin-top: 6px;
    font-size: 13px;
  }

  .rank-item {
    padding: 6px 8px;
    border-radius: 12px;
    display: flex;
    justify-content: space-between;
    align-items: center;
    border: 1px solid #e5e7eb;
    background: #f1f5f9;
    margin-bottom: 4px;
  }

  .rank-label {
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .rank-num {
    font-size: 12px;
    border-radius: 999px;
    padding: 2px 7px;
    border: 1px solid #bfdbfe;
    color: #1d4ed8;
    background: #eff6ff;
  }

  .rank-name {
    font-size: 13px;
    color: #111827;
  }

  .rank-votes {
    font-size: 12px;
    color: #16a34a;
    font-weight: 600;
  }

  .empty-text {
    font-size: 12px;
    color: #9ca3af;
    margin-top: 6px;
  }

  /* ê´€ë¦¬ì */

  .admin-toggle {
    font-size: 11px;
    color: #64748b;
    text-align: right;
    margin-top: 8px;
    cursor: pointer;
  }

  .admin-section {
    margin-top: 8px;
    padding-top: 8px;
    border-top: 1px dashed #e5e7eb;
    font-size: 12px;
    display: none;
    gap: 8px;
    flex-direction: column;
  }

  .admin-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
  }

  .admin-section input {
    padding: 6px 8px;
    border-radius: 8px;
    border: 1px solid #cbd5f5;
    background: #ffffff;
    color: #0f172a;
    font-size: 12px;
  }

  .admin-section input:focus {
    outline: none;
    border-color: #2563eb;
    box-shadow: 0 0 0 2px rgba(37,99,235,0.15);
  }

  .admin-btn {
    font-size: 11px;
    border-radius: 999px;
    border: 1px solid #bfdbfe;
    background: #eff6ff;
    color: #1d4ed8;
    cursor: pointer;
    padding: 4px 8px;
    white-space: nowrap;
    transition: background 0.08s ease;
  }

  .admin-btn:hover {
    background: #e0f2fe;
  }

  .admin-btn.danger {
    border-color: #fecaca;
    background: #fef2f2;
    color: #b91c1c;
  }

  /* ê²Œì‹œíŒ / ì²­ìš´ìš°ì²´í†µ ê³µí†µ */

  .letter-layout {
    display: flex;
    flex-direction: column;
    gap: 16px;
    max-width: 800px;
    margin: 0 auto;
  }

  .letter-title {
    font-size: 18px;
    font-weight: 800;
    margin-bottom: 4px;
    color: #1d4ed8;
    display: flex;
    align-items: center;
    gap: 6px;
  }

  .letter-sub {
    font-size: 12px;
    color: #4b5563;
    margin-bottom: 10px;
  }

  .letter-form {
    display: flex;
    flex-direction: column;
    gap: 8px;
    font-size: 13px;
  }

  .letter-form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    align-items: center;
  }

  .letter-form input[type="text"],
  .letter-form textarea {
    width: 100%;
    padding: 8px 10px;
    border-radius: 12px;
    border: 1px solid #cbd5f5;
    background: #ffffff;
    color: #0f172a;
    font-size: 13px;
    resize: vertical;
  }

  .letter-form textarea {
    min-height: 80px;
  }

  .letter-form input[type="file"] {
    font-size: 12px;
    color: #374151;
  }

  .letter-form button {
    align-self: flex-end;
    padding: 8px 14px;
    border-radius: 999px;
    border: none;
    background: linear-gradient(to right, #3b82f6, #6366f1);
    color: #f9fafb;
    font-size: 13px;
    font-weight: 700;
    cursor: pointer;
    box-shadow: 0 4px 12px rgba(79,70,229,0.6);
    transition: transform 0.08s ease, box-shadow 0.08s ease;
  }

  .letter-form button:hover {
    transform: translateY(-1px);
    box-shadow: 0 6px 14px rgba(79,70,229,0.75);
  }

  .letter-list {
    display: flex;
    flex-direction: column;
    gap: 10px;
    font-size: 13px;
    max-height: 420px;
    overflow-y: auto;
  }

  .letter-item {
    padding: 8px 0;
    border-radius: 12px;
  }

  .letter-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
    padding: 0 4px;
  }

  .letter-name {
    font-weight: 600;
    font-size: 13px;
    color: #0f172a;
  }

  .letter-tag {
    font-size: 11px;
    color: #2563eb;
    margin-left: 6px;
  }

  .letter-time {
    font-size: 11px;
    color: #6b7280;
  }

  .letter-bubble {
    position: relative;
    display: inline-block;
    max-width: 100%;
    background: #f3f4ff;
    border-radius: 20px;
    padding: 10px 12px;
    border: 1px solid #dbeafe;
    margin-top: 8px;
    margin-bottom: 8px;
  }

  .letter-bubble::after {
    content: "";
    position: absolute;
    left: 18px;
    bottom: -7px;
    width: 22px;
    height: 12px;
    background: #f3f4ff;
    border-radius: 999px;
  }

  .letter-message {
    font-size: 13px;
    color: #111827;
    line-height: 1.6;
    white-space: pre-wrap;
    background: #ffffff;
    padding: 8px 10px;
    border-radius: 12px;
  }

  .letter-image {
    margin-top: 8px;
    border-radius: 12px;
    max-width: 100%;
    max-height: 260px;
    object-fit: cover;
    border: 1px solid #dbeafe;
    background: #ffffff;
  }

  /* ë‹µê¸€ */

  .reply-list {
    margin-top: 4px;
    margin-left: 24px;
    display: flex;
    flex-direction: column;
    gap: 6px;
  }

  .reply-item {
    display: flex;
    justify-content: flex-start;
  }

  .reply-bubble {
    max-width: 100%;
    background: #e5f0ff;
    border-radius: 16px;
    padding: 8px 10px;
    border: 1px solid #dbeafe;
    font-size: 12px;
  }

  .reply-meta {
    font-size: 11px;
    color: #6b7280;
    margin-bottom: 2px;
  }

  .reply-message {
    font-size: 12px;
    color: #111827;
    white-space: pre-wrap;
    background: #ffffff;
    padding: 4px 6px;
    border-radius: 8px;
  }

  .reply-toggle {
    margin-top: 4px;
    font-size: 11px;
    color: #2563eb;
    background: transparent;
    border: none;
    padding: 0 4px;
    cursor: pointer;
  }

  .reply-form {
    margin-top: 6px;
    margin-left: 24px;
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px dashed #dbeafe;
    display: flex;
    flex-direction: column;
    gap: 6px;
    font-size: 12px;
    background: #f3f4ff;
  }

  .reply-form-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    align-items: center;
  }

  .reply-form input[type="text"],
  .reply-form textarea {
    width: 100%;
    padding: 6px 8px;
    border-radius: 8px;
    border: 1px solid #cbd5f5;
    background: #ffffff;
    color: #0f172a;
    font-size: 12px;
    resize: vertical;
  }

  .hidden {
    display: none !important;
  }

  /* ì²­ìš´ìš°ì²´í†µ ì œëª©ì— ìš°ì²´í†µ ì•„ì´ì½˜ */
  #view-cheongun .letter-title::before {
    content: "ğŸ“®";
    font-size: 20px;
  }
  </style>

</head>
<body>
  <header>
    <div>
      <div class="logo">í•™êµ ì´ë²¤íŠ¸ì¡´</div>
      <div class="subtitle">ì‹¤ì‹œê°„ íˆ¬í‘œ Â· ê²Œì‹œíŒ Â· ì²­ìš´ìš°ì²´í†µ</div>
    </div>
    <nav class="nav-tabs">
      <button class="nav-btn active" data-view="vote">íˆ¬í‘œì¡´</button>
      <button class="nav-btn" data-view="letter">ê²Œì‹œíŒ</button>
      <button class="nav-btn" data-view="cheongun">ì²­ìš´ìš°ì²´í†µ</button>
    </nav>
  </header>

  <main>
    <!-- VIEW 1: íˆ¬í‘œì¡´ -->
    <div id="view-vote" class="vote-layout">
      <!-- ì¢Œì¸¡: ì§ˆë¬¸ ëª©ë¡ -->
      <aside class="panel">
        <div class="panel-title">íˆ¬í‘œ ì§ˆë¬¸ ëª©ë¡</div>
        <div class="question-list" id="question-list"></div>
      </aside>

      <!-- ì¤‘ì•™: í˜„ì¬ ì§ˆë¬¸ ì¹´ë“œ -->
      <section class="card">
        <div>
          <div class="card-tag" id="card-tag">Q1</div>
          <div class="card-title" id="card-title">ì§ˆë¬¸ ì œëª©</div>
          <div class="card-desc" id="card-desc">ì§ˆë¬¸ ì„¤ëª…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤.</div>
          <div class="card-meta">ì´ íˆ¬í‘œ ìˆ˜: <span id="total-votes">0</span>í‘œ</div>
        </div>

        <div>
          <div style="font-size: 12px; color:#9ca3af; margin-bottom:4px;">
            * ì´ë¦„ í˜¹ì€ ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”. (í•™ë²ˆ+ì´ë¦„ ì¶”ì²œ ì˜ˆ: 10506_ì •ì—°)
          </div>
          <form class="vote-form" id="vote-form">
            <input type="text" id="vote-name" placeholder="íˆ¬í‘œí•  ì‚¬ëŒ ì´ë¦„ ë˜ëŠ” ë‹‰ë„¤ì„">
            <button type="submit">ì´ ì§ˆë¬¸ì— íˆ¬í‘œí•˜ê¸°</button>
          </form>
          <!-- ì´ì „ ì§ˆë¬¸ ë²„íŠ¼ë§Œ -->
          <button id="prev-question-btn" class="next-question-btn">ì´ì „ ì§ˆë¬¸</button>
        </div>
        <button id="next-question-btn" class="next-question-btn">ë‹¤ìŒ ì§ˆë¬¸</button>
      </section>


      <!-- ìš°ì¸¡: ë­í‚¹ + ê´€ë¦¬ì -->
      <aside class="panel">
        <div class="ranking-header">
          <div class="panel-title">ì‹¤ì‹œê°„ TOP 5</div>
        </div>
        <div class="ranking-sub" id="ranking-sub">ì§ˆë¬¸ì„ ì„ íƒí•˜ë©´ ë­í‚¹ì´ í‘œì‹œë©ë‹ˆë‹¤.</div>
        <div class="ranking-list" id="ranking-list"></div>
        <div class="empty-text" id="ranking-empty">ì•„ì§ íˆ¬í‘œê°€ ì—†ì–´ìš”. ì²« ë²ˆì§¸ íˆ¬í‘œë¥¼ í•´ ë³´ì„¸ìš”!</div>

        <div class="admin-toggle" id="admin-toggle">ê´€ë¦¬ì ëª¨ë“œ ì—´ê¸°</div>
        <div class="admin-section" id="admin-section">
          <div class="admin-row">
            <span>ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸:</span>
            <input type="password" id="admin-password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
            <button class="admin-btn" id="admin-login-btn">í™•ì¸</button>
          </div>
          <div id="admin-body" style="display:none;">
            <div style="margin-top:4px; color:#9ca3af;">â€» ê°„ë‹¨ ê´€ë¦¬ì ê¸°ëŠ¥ (í˜„ì¬ ì§ˆë¬¸ ê¸°ì¤€)</div>
            <div class="admin-row">
              <span>ìˆ¨ê¸¸ ì´ë¦„:</span>
              <input type="text" id="hide-name-input" placeholder="ìˆ¨ê¸¸ ì´ë¦„/ë‹‰ë„¤ì„">
              <button class="admin-btn" id="hide-name-btn">ìˆ¨ê¸°ê¸°</button>
            </div>
            <div class="admin-row">
              <button class="admin-btn" id="reset-votes-btn">í˜„ì¬ ì§ˆë¬¸ íˆ¬í‘œ ì´ˆê¸°í™”</button>
              <button class="admin-btn danger" id="clear-question-btn">í˜„ì¬ ì§ˆë¬¸ ì „ì²´ ì‚­ì œ(ì§ˆë¬¸+íˆ¬í‘œ)</button>
            </div>
          </div>
        </div>
      </aside>
    </div>

    <!-- VIEW 2: ê²Œì‹œíŒ -->
    <div id="view-letter" class="letter-layout hidden">
      <section class="panel">
        <div class="letter-title">ê²Œì‹œíŒ</div>
        <div class="letter-sub">
          í•˜ê³  ì‹¶ì€ ë§, ìµëª…ìœ¼ë¡œ ë‚¨ê¸°ê³  ì‹¶ì€ ì´ì•¼ê¸°, ìš´ì˜ì§„/ê´€ë¦¬ìì—ê²Œ ì „í•˜ê³  ì‹¶ì€ ë©”ì‹œì§€ë¥¼ ììœ ë¡­ê²Œ ì˜¬ë ¤ ì£¼ì„¸ìš”. (ì´ë¯¸ì§€ 1ì¥ ì²¨ë¶€ ê°€ëŠ¥)
        </div>
        <form class="letter-form" id="letter-form">
          <div class="letter-form-row">
            <label style="display:flex;align-items:center;gap:4px;font-size:12px;">
              <input type="checkbox" id="letter-anon" checked>
              ìµëª…ìœ¼ë¡œ ì˜¬ë¦¬ê¸°
            </label>
          </div>
          <div class="letter-form-row">
            <input type="text" id="letter-name" placeholder="ì‹¤ëª… ë˜ëŠ” ë³„ëª… (ìµëª…ì´ ì•„ë‹ˆë©´ í•„ìˆ˜)" disabled>
          </div>
          <textarea id="letter-message" placeholder="ê²Œì‹œê¸€ ë‚´ìš©ì„ ììœ ë¡­ê²Œ ì ì–´ ì£¼ì„¸ìš”. (ê¸°ë³¸ì ì¸ ì˜ˆì˜ëŠ” ì§€í‚¤ê¸°!)"></textarea>
          <div class="letter-form-row">
            <span style="font-size:12px; color:#9ca3af;">ì´ë¯¸ì§€ ì²¨ë¶€ (ì„ íƒ):</span>
            <input type="file" id="letter-image" accept="image/*">
          </div>
          <button type="submit">ê²Œì‹œê¸€ ì˜¬ë¦¬ê¸°</button>
        </form>
      </section>

      <section class="panel">
        <div class="panel-title">ê²Œì‹œê¸€ ëª©ë¡</div>
        <div class="letter-sub">ìµœì‹  ìˆœìœ¼ë¡œ ìµœëŒ€ 50ê°œê¹Œì§€ ë³´ì—¬ì§‘ë‹ˆë‹¤. (ë‹µê¸€ ê°€ëŠ¥)</div>
        <div id="letter-list" class="letter-list"></div>
        <div class="empty-text" id="letter-empty">ì•„ì§ ì˜¬ë¼ì˜¨ ê¸€ì´ ì—†ì–´ìš”. ì²« ë²ˆì§¸ ê¸€ì˜ ì£¼ì¸ê³µì´ ë˜ì–´ ë³´ì„¸ìš”!</div>
      </section>
    </div>

    <!-- VIEW 3: ì²­ìš´ìš°ì²´í†µ -->
    <div id="view-cheongun" class="letter-layout hidden">
      <section class="panel">
        <div class="letter-title">ì²­ìš´ìš°ì²´í†µ</div>
        <div class="letter-sub" id="cheongun-info-text">
          ì²­ìš´ìš°ì²´í†µì€ <b>í‰ì†Œ ìš©ê¸° ë‚´ì„œ ë§í•˜ì§€ ëª»í–ˆë˜ ë§ˆìŒì„ ë”± í•œ ì‚¬ëŒì—ê²Œë§Œ</b> ì¡°ìš©íˆ ì „í•˜ëŠ” í¸ì§€í•¨ì…ë‹ˆë‹¤.<br>
          ì´ í˜ì´ì§€ì—ì„œëŠ” í•œ ì‚¬ëŒë‹¹ í•œ ë²ˆë§Œ, ê°€ì¥ ì „í•˜ê³  ì‹¶ì—ˆë˜ ì‚¬ëŒì„ ë– ì˜¬ë ¤ í¸ì§€ë¥¼ ì“¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.<br>
          ì—¬ê¸°ì—ì„œ ì‘ì„±í•œ í¸ì§€ëŠ” <b>ê´€ë¦¬ìì¸ ë‚´ê°€ ë¨¼ì € ë°›ì€ ë’¤, ë‚˜ì¤‘ì— ì˜¤í”„ë¼ì¸ì—ì„œ ì‹¤ì œë¡œ ì¸ì‡„í•˜ê±°ë‚˜ ì§ì ‘ ì „ë‹¬í•  ì˜ˆì •</b>ì…ë‹ˆë‹¤.<br>
          â€» ê°™ì€ ê¸°ê¸°ì—ì„œëŠ” ì²­ìš´ìš°ì²´í†µì„ í•œ ë²ˆ ë³´ë‚¸ ë’¤ì—ëŠ” ë‹¤ì‹œ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
        </div>
        <form class="letter-form" id="cheongun-form">
          <div class="letter-form-row">
            <input type="text" id="cheongun-from" placeholder="ë³´ë‚´ëŠ” ì‚¬ëŒ (ì„ íƒ: í•™ë²ˆ+ì´ë¦„ ë˜ëŠ” ë‹‰ë„¤ì„)">
          </div>
          <div class="letter-form-row">
            <input type="text" id="cheongun-to" placeholder="ë°›ëŠ” ì‚¬ëŒ (í•„ìˆ˜: í•™ë²ˆ+ì´ë¦„ ë˜ëŠ” ë‹‰ë„¤ì„)">
          </div>
          <textarea id="cheongun-message" placeholder="í‰ì†Œ í•˜ê³  ì‹¶ì—ˆì§€ë§Œ ì „í•˜ì§€ ëª»í–ˆë˜ ë§ì„ ì§„ì‹¬ì„ ë‹´ì•„ ì ì–´ ì£¼ì„¸ìš”. (ì‘ì„± í›„ ìˆ˜ì •/ì‚­ì œ ë¶ˆê°€)"></textarea>
          <button type="submit" id="cheongun-submit-btn">ì²­ìš´ìš°ì²´í†µì— ë„£ê¸°</button>
        </form>
      </section>
    </div>
  </main>

  <!-- Firebase SDK (Realtime DBë§Œ ì‚¬ìš©) -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // ==============================
    // 1. Firebase ì´ˆê¸°í™”
    // ==============================
    const firebaseConfig = {
      apiKey: "AIzaSyCY0nrWOtl5mj9fSckXY1ljcfMIEzIYH5s",
      authDomain: "sion-a8988.firebaseapp.com",
      projectId: "sion-a8988",
      storageBucket: "sion-a8988.firebasestorage.app",
      messagingSenderId: "551701763906",
      appId: "1:551701763906:web:bf26ac9dfc7be1f5f21adb",
      measurementId: "G-N1E8SZYMCN",
      databaseURL: "https://sion-a8988-default-rtdb.firebaseio.com"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();

    // ==============================
    // ê³µí†µ: ë·° ì „í™˜ (íˆ¬í‘œ / ê²Œì‹œíŒ / ì²­ìš´ìš°ì²´í†µ)
    // ==============================
    const navButtons = document.querySelectorAll('.nav-btn');
    const viewVote = document.getElementById('view-vote');
    const viewLetter = document.getElementById('view-letter');
    const viewCheongun = document.getElementById('view-cheongun');

    function showView(view) {
      viewVote.classList.add('hidden');
      viewLetter.classList.add('hidden');
      viewCheongun.classList.add('hidden');

      if (view === 'vote') viewVote.classList.remove('hidden');
      else if (view === 'letter') viewLetter.classList.remove('hidden');
      else if (view === 'cheongun') viewCheongun.classList.remove('hidden');
    }

    navButtons.forEach(btn => {
      btn.addEventListener('click', () => {
        const view = btn.dataset.view;
        navButtons.forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        showView(view);
      });
    });

    // ê¸°ë³¸ ë·°
    showView('vote');

    // ==============================
    // ğŸ”¥ ê¸°ê¸° ê³ ìœ  ID ìƒì„± (ê¸°ê¸° 1íšŒ ì œí•œìš©)
    // ==============================
    if (!localStorage.getItem("device_id")) {
      const rand = (crypto.randomUUID ? crypto.randomUUID() : String(Math.random()).slice(2));
      localStorage.setItem("device_id", "dev_" + rand);
    }
    const deviceId = localStorage.getItem("device_id");

    // ==============================
    // 2. ê¸°ë³¸ ì§ˆë¬¸ ë°ì´í„° (ìµœì´ˆ 1íšŒìš©)
    // ==============================
    const defaultQuestions = [
      {
        id: 'funniest',
        tag: 'Q1',
        title: 'ìš°ë¦¬ í•™êµì—ì„œ ê°€ì¥ ì›ƒê¸´ ì‚¬ëŒì€?',
        desc: 'ë§í•  ë•Œë§ˆë‹¤ ì£¼ë³€ì„ ë¹µ í„°ëœ¨ë¦¬ëŠ” ì…ë‹´ ìµœê°•ìì—ê²Œ í•œ í‘œë¥¼ ì£¼ì„¸ìš”!'
      },
      {
        id: 'kindest',
        tag: 'Q2',
        title: 'ìš°ë¦¬ í•™êµì—ì„œ ê°€ì¥ ì¹œì ˆí•œ ì‚¬ëŒì€?',
        desc: 'í•­ìƒ ë¨¼ì € ë„ì™€ì£¼ê³  ë°°ë ¤í•´ ì£¼ëŠ” ì²œì‚¬ ê°™ì€ ì¹œêµ¬ëŠ” ëˆ„êµ¬ì¸ê°€ìš”?'
      },
      {
        id: 'presentation',
        tag: 'Q3',
        title: 'ë°œí‘œ/í”„ë ˆì  í…Œì´ì…˜ì„ ì œì¼ ì˜í•˜ëŠ” ì‚¬ëŒì€?',
        desc: 'ìˆ˜ì—…Â·ìˆ˜í–‰í‰ê°€ì—ì„œ í”„ë ˆì  í…Œì´ì…˜ ì¥ì¸ì´ë¼ê³  ëŠê»´ì§€ëŠ” ì¹œêµ¬ì—ê²Œ íˆ¬í‘œí•´ ë³´ì„¸ìš”.'
      },
      {
        id: 'fashion',
        tag: 'Q4',
        title: 'íŒ¨ì…˜ ê°ê°ì´ ê°€ì¥ ì¢‹ì€ ì‚¬ëŒì€?',
        desc: 'êµë³µì´ë“  ì‚¬ë³µì´ë“  ìŠ¤íƒ€ì¼ ì°¢ëŠ” íŒ¨ì…˜ ë¦¬ë”ì—ê²Œ í•œ í‘œ!'
      },
      {
        id: 'hardworking',
        tag: 'Q5',
        title: 'ê°€ì¥ ì„±ì‹¤í•˜ê²Œ ë…¸ë ¥í•˜ëŠ” ì‚¬ëŒì€?',
        desc: 'ë¬µë¬µíˆ ìê¸° ìë¦¬ì—ì„œ ìµœì„ ì„ ë‹¤í•˜ëŠ” ë…¸ë ¥ì™•ì„ ì¶”ì²œí•´ ì£¼ì„¸ìš”.'
      },
      {
        id: 'funniest2',
        tag: 'Q6',
        title: 'ìš°ë¦¬ í•™êµì—ì„œ ê°€ì¥ ì›ƒê¸´ ì‚¬ëŒì€? (2)',
        desc: 'ë‹¤ë¥¸ ë°˜ê¹Œì§€ ì†Œë¬¸ë‚œ ë ˆì „ë“œ ê°œê·¸ìºì—ê²Œ í•œ í‘œ!'
      },
      {
        id: 'kindest2',
        tag: 'Q7',
        title: 'ìš°ë¦¬ í•™êµì—ì„œ ê°€ì¥ ë‹¤ì •í•œ ì‚¬ëŒì€?',
        desc: 'ë§íˆ¬ë¶€í„° í–‰ë™ê¹Œì§€ ë‹¤ì •ë‹¤ê°í•œ íë§ìºëŠ” ëˆ„êµ¬ì¸ê°€ìš”?'
      },
      {
        id: 'presentation2',
        tag: 'Q8',
        title: 'ë°œí‘œí•  ë•Œ ê°€ì¥ ë¯¿ìŒì§í•œ ì‚¬ëŒì€?',
        desc: 'ì¡° ë°œí‘œ ë§¡ê¸°ë©´ ìë™ìœ¼ë¡œ ë“ ë“ í•´ì§€ëŠ” ê·¸ ì¹œêµ¬!'
      },
      {
        id: 'fashion2',
        tag: 'Q9',
        title: 'ê°€ì¥ ê¾¸ì•ˆê¾¸ ìŠ¤íƒ€ì¼ì´ ì°°ë–¡ì¸ ì‚¬ëŒì€?',
        desc: 'ëŒ€ì¶© ì…ì€ ê²ƒ ê°™ì€ë° ì™ ì§€ ë©‹ìˆëŠ” ì¹œêµ¬ì—ê²Œ íˆ¬í‘œí•´ ë³´ì„¸ìš”.'
      },
      {
        id: 'hardworking2',
        tag: 'Q10',
        title: 'ëŠ˜ ì¡°ìš©íˆ ë’·ìë¦¬ì—ì„œ ë…¸ë ¥í•˜ëŠ” ì‚¬ëŒì€?',
        desc: 'í‹°ëŠ” ì•ˆ ë‚˜ì§€ë§Œ í•­ìƒ ì¤€ë¹„ë˜ì–´ ìˆëŠ” ìˆ¨ì€ ë…¸ë ¥ì™•!'
      }
    ];

    // DB êµ¬ì¡°:
    // /questions/{id}
    // /votes/{questionId}/{name}
    // /hiddenNames/{questionId}/{name}
    // /deviceVotes/{questionId}/{deviceId}
    // /letters/{letterId}
    // /letterReplies/{letterId}/{replyId}
    // /cheongunLetters/{letterId}
    // /cheongunDevice/{deviceId} = letterId

    let questions = [];
    let currentQuestionId = null;
    let voteData = {};
    let hiddenNames = {};
    let currentVotesRef = null;
    let currentHiddenRef = null;

    // í•œ ë²ˆì— ë³´ì—¬ì¤„ ì§ˆë¬¸ ìˆ˜
    const PAGE_SIZE = 4;

    // í˜„ì¬ ëª‡ ë²ˆì§¸ ì„¸íŠ¸ì¸ì§€
    let questionPage = 0;

    // ì´ ë¸Œë¼ìš°ì €ê°€ í•œ ë²ˆì´ë¼ë„ íˆ¬í‘œí•œ ì§ˆë¬¸ ID ëª©ë¡
    let votedQuestions = new Set(
      JSON.parse(localStorage.getItem('votedQuestions') || '[]')
    );

    function saveVotedQuestions() {
      localStorage.setItem('votedQuestions', JSON.stringify(Array.from(votedQuestions)));
    }

    function markQuestionVoted(qid) {
      if (!qid) return;
      votedQuestions.add(qid);
      saveVotedQuestions();
    }

    // íŠ¹ì • í˜ì´ì§€(ì„¸íŠ¸)ì˜ ì§ˆë¬¸ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    function getPageQuestions(pageIndex) {
      const start = pageIndex * PAGE_SIZE;
      return questions.slice(start, start + PAGE_SIZE);
    }

    // ì²˜ìŒ ë¡œë”©í•  ë•Œ, ì•„ì§ ì•ˆ ëë‚¸ ì„¸íŠ¸ ì°¾ê¸°
    function findInitialPage() {
      const totalPages = Math.ceil(questions.length / PAGE_SIZE);
      if (totalPages === 0) {
        questionPage = 0;
        return;
      }

      let chosen = 0;
      for (let p = 0; p < totalPages; p++) {
        const slice = getPageQuestions(p);
        const hasUnvoted = slice.some(q => !votedQuestions.has(q.id));
        if (hasUnvoted) {
          chosen = p;
          break;
        } else {
          chosen = totalPages - 1;
        }
      }
      questionPage = chosen;
    }

    // ==============================
    // 3. ì§ˆë¬¸ ë¡œë”© & ì´ˆê¸° ì„¸íŒ… (ë§¤ë²ˆ defaultQuestionsë¡œ ì´ˆê¸°í™” ë²„ì „)
    // ==============================
    function initQuestionsFromFirebase() {
      const qRef = db.ref('questions');

      // localStorageì— ì €ì¥ëœ íˆ¬í‘œ ì™„ë£Œ ì •ë³´ ë¦¬ì…‹ (í…ŒìŠ¤íŠ¸ìš©)
      votedQuestions = new Set();
      saveVotedQuestions();

      const updates = {};
      defaultQuestions.forEach(q => {
        updates[q.id] = {
          tag: q.tag,
          title: q.title,
          desc: q.desc,
          active: true
        };
      });

      qRef
        .set(updates)
        .then(() => {
          questions = defaultQuestions.map(q => ({ ...q, active: true }));

          if (questions.length === 0) {
            alert('í™œì„±í™”ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ì„œ ì§ˆë¬¸ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.');
            return;
          }

          questions.sort((a, b) => (a.tag || '').localeCompare(b.tag || ''));

          findInitialPage();

          const pageQuestions = getPageQuestions(questionPage);
          if (pageQuestions.length === 0) {
            alert('í‘œì‹œí•  ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
          }

          currentQuestionId = pageQuestions[0].id;
          renderQuestionList();
          switchQuestion(currentQuestionId);
        })
        .catch(err => {
          console.error(err);
          alert('ì§ˆë¬¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
    }

    function renderQuestionList() {
      questionListEl.innerHTML = '';

      const pageQuestions = getPageQuestions(questionPage);

      pageQuestions.forEach(q => {
        const div = document.createElement('div');
        const isActive = q.id === currentQuestionId;
        const isVoted = votedQuestions.has(q.id);

        div.className = 'question-item' + (isActive ? ' active' : '');
        div.dataset.id = q.id;
        div.innerHTML = `
          <div>${q.title}</div>
          <small>${q.tag}${isVoted ? ' Â· âœ… íˆ¬í‘œì™„ë£Œ' : ''}</small>
        `;
        div.addEventListener('click', () => {
          switchQuestion(q.id);
        });
        questionListEl.appendChild(div);
      });

      const totalPages = Math.ceil(questions.length / PAGE_SIZE);
      if (totalPages > 1) {
        const info = document.createElement('div');
        info.style.marginTop = '6px';
        info.style.fontSize = '11px';
        info.style.color = '#6b7280';
        info.textContent = `í˜„ì¬ ì„¸íŠ¸ ${questionPage + 1} / ${totalPages}`;
        questionListEl.appendChild(info);
      }
    }

    // ==============================
    // ì´ì „ / ë‹¤ìŒ ì§ˆë¬¸ ì´ë™
    // ==============================
    function advanceToPrevQuestion() {
      const slice = getPageQuestions(questionPage);
      if (slice.length === 0) return;

      const idx = slice.findIndex(q => q.id === currentQuestionId);
      const totalPages = Math.ceil(questions.length / PAGE_SIZE);

      if (idx === -1) {
        switchQuestion(slice[0].id);
        return;
      }

      // 1) ê°™ì€ ì„¸íŠ¸ ì•ˆì—ì„œ ì´ì „ ì§ˆë¬¸ì´ ìˆìœ¼ë©´
      if (idx > 0) {
        switchQuestion(slice[idx - 1].id);
        return;
      }

      // 2) ì´ ì„¸íŠ¸ì˜ ì²« ë²ˆì§¸ ì§ˆë¬¸ì¸ë°, ì´ì „ ì„¸íŠ¸ê°€ ìˆìœ¼ë©´
      if (idx === 0 && questionPage > 0) {
        questionPage--;
        renderQuestionList();
        const prevSlice = getPageQuestions(questionPage);
        if (prevSlice.length > 0) {
          switchQuestion(prevSlice[prevSlice.length - 1].id);
        }
        return;
      }

      // 3) ì™„ì „ ì²« ì§ˆë¬¸
      alert('ì²« ë²ˆì§¸ ì§ˆë¬¸ì…ë‹ˆë‹¤!');
    }

    function advanceToNextQuestion() {
      const slice = getPageQuestions(questionPage);
      if (slice.length === 0) return;

      const idx = slice.findIndex(q => q.id === currentQuestionId);
      const totalPages = Math.ceil(questions.length / PAGE_SIZE);

      if (idx === -1) {
        switchQuestion(slice[0].id);
        return;
      }

      // 1) ê°™ì€ ì„¸íŠ¸ ì•ˆì—ì„œ ë‹¤ìŒ ì§ˆë¬¸ì´ ìˆìœ¼ë©´
      if (idx < slice.length - 1) {
        switchQuestion(slice[idx + 1].id);
        return;
      }

      // 2) ì´ ì„¸íŠ¸ì˜ ë§ˆì§€ë§‰ ì§ˆë¬¸ì´ê³ , ë‹¤ìŒ ì„¸íŠ¸ê°€ ìˆìœ¼ë©´ â†’ ë‹¤ìŒ ì„¸íŠ¸ ì²« ì§ˆë¬¸
      if (questionPage < totalPages - 1) {
        questionPage++;
        renderQuestionList();
        const nextSlice = getPageQuestions(questionPage);
        if (nextSlice.length > 0) {
          switchQuestion(nextSlice[0].id);
        }
        return;
      }

      // 3) ì™„ì „ ë§ˆì§€ë§‰ ì§ˆë¬¸
      alert("ë§ˆì§€ë§‰ ì§ˆë¬¸ì…ë‹ˆë‹¤!");
    }

    // íˆ¬í‘œ DOM
    const questionListEl = document.getElementById('question-list');
    const cardTagEl = document.getElementById('card-tag');
    const cardTitleEl = document.getElementById('card-title');
    const cardDescEl = document.getElementById('card-desc');
    const totalVotesEl = document.getElementById('total-votes');
    const voteFormEl = document.getElementById('vote-form');
    const voteNameEl = document.getElementById('vote-name');
    const rankingListEl = document.getElementById('ranking-list');
    const rankingSubEl = document.getElementById('ranking-sub');
    const rankingEmptyEl = document.getElementById('ranking-empty');

    const adminToggleEl = document.getElementById('admin-toggle');
    const adminSectionEl = document.getElementById('admin-section');
    const adminPasswordEl = document.getElementById('admin-password');
    const adminLoginBtnEl = document.getElementById('admin-login-btn');
    const adminBodyEl = document.getElementById('admin-body');
    const hideNameInputEl = document.getElementById('hide-name-input');
    const hideNameBtnEl = document.getElementById('hide-name-btn');
    const resetVotesBtnEl = document.getElementById('reset-votes-btn');
    const clearQuestionBtnEl = document.getElementById('clear-question-btn');

    const ADMIN_PASSWORD = "admin1234";

    // ì´ì „ ë²„íŠ¼
    const prevBtn = document.getElementById('prev-question-btn');
    prevBtn.addEventListener('click', () => {
      advanceToPrevQuestion();
    });
    const nextBtn = document.getElementById('next-question-btn');
nextBtn.addEventListener('click', () => {
  advanceToNextQuestion();
});

    // ==============================
    // 4. ì§ˆë¬¸ ì „í™˜ + ë¦¬ìŠ¤ë„ˆ ì„¤ì •
    // ==============================
    function detachCurrentListeners() {
      if (currentVotesRef) currentVotesRef.off();
      if (currentHiddenRef) currentHiddenRef.off();
    }

    function switchQuestion(qid) {
      currentQuestionId = qid;
      renderQuestionList();
      const q = questions.find(item => item.id === qid);
      if (!q) return;

      cardTagEl.textContent = q.tag;
      cardTitleEl.textContent = q.title;
      cardDescEl.textContent = q.desc;
      rankingSubEl.textContent = `${q.tag} ${q.title}`;

      detachCurrentListeners();

      currentVotesRef = db.ref('votes/' + qid);
      currentHiddenRef = db.ref('hiddenNames/' + qid);

      currentVotesRef.on('value', snapshot => {
        voteData[qid] = snapshot.val() || {};
        renderVotesAndRanking();
      });

      currentHiddenRef.on('value', snapshot => {
        hiddenNames[qid] = snapshot.val() || {};
        renderVotesAndRanking();
      });
    }

    function renderVotesAndRanking() {
      if (!currentQuestionId) return;

      const votes = voteData[currentQuestionId] || {};
      const hidden = hiddenNames[currentQuestionId] || {};

      const total = Object.values(votes).reduce((a, b) => a + b, 0);
      totalVotesEl.textContent = total;

      const entries = Object.entries(votes)
        .filter(([name]) => !hidden[name]);

      entries.sort((a, b) => b[1] - a[1] || a[0].localeCompare(b[0]));

      rankingListEl.innerHTML = '';
      if (entries.length === 0) {
        rankingEmptyEl.style.display = 'block';
        return;
      }
      rankingEmptyEl.style.display = 'none';

      const top5 = entries.slice(0, 5);
      top5.forEach((item, index) => {
        const [name, count] = item;
        const div = document.createElement('div');
        div.className = 'rank-item';
        div.innerHTML = `
          <div class="rank-label">
            <div class="rank-num">${index + 1}ìœ„</div>
            <div class="rank-name">${name}</div>
          </div>
          <div class="rank-votes">${count}í‘œ</div>
        `;
        rankingListEl.appendChild(div);
      });
    }

    // ==============================
    // 5. íˆ¬í‘œ ì²˜ë¦¬ (ì¤‘ë³µ ë°©ì§€ í¬í•¨ + ìë™ ë‹¤ìŒ ì§ˆë¬¸ ì´ë™)
    // ==============================
    voteFormEl.addEventListener('submit', (e) => {
      e.preventDefault();
      const rawName = voteNameEl.value.trim();
      if (!rawName) {
        alert('íˆ¬í‘œí•  ì‚¬ëŒì˜ ì´ë¦„ ë˜ëŠ” ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }
      if (rawName.length > 20) {
        alert('ì´ë¦„/ë‹‰ë„¤ì„ì€ 20ì ì´í•˜ë¡œ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }
      if (!currentQuestionId) return;

      const nameKey = rawName;

      const deviceRef = db.ref('deviceVotes/' + currentQuestionId + '/' + deviceId);
      deviceRef.once('value').then(deviceSnap => {
        if (deviceSnap.exists()) {
          alert('ì´ ê¸°ê¸°ì—ì„œëŠ” ì´ë¯¸ ì´ ì§ˆë¬¸ì— íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤!');
          return;
        }

        const nameRef = db.ref('votes/' + currentQuestionId + '/' + nameKey);
        nameRef.once('value').then(nameSnap => {
          if (nameSnap.exists()) {
            alert('ì´ ì´ë¦„ìœ¼ë¡œëŠ” ì´ë¯¸ íˆ¬í‘œí–ˆìŠµë‹ˆë‹¤!');
            return;
          }

          const updates = {};
          updates['votes/' + currentQuestionId + '/' + nameKey] = 1;
          updates['deviceVotes/' + currentQuestionId + '/' + deviceId] = true;

          db.ref().update(updates).then(() => {
            voteNameEl.value = '';

            markQuestionVoted(currentQuestionId);
            renderQuestionList();

            // âœ… íˆ¬í‘œ ì„±ê³µ í›„ ìë™ìœ¼ë¡œ ë‹¤ìŒ ì§ˆë¬¸ìœ¼ë¡œ ì´ë™
            advanceToNextQuestion();
          }).catch(error => {
            console.error(error);
            alert('íˆ¬í‘œ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          });
        });
      });
    });

    // ==============================
    // 6. ê´€ë¦¬ì ê¸°ëŠ¥
    // ==============================
    adminToggleEl.addEventListener('click', () => {
      if (adminSectionEl.style.display === 'flex') {
        adminSectionEl.style.display = 'none';
      } else {
        adminSectionEl.style.display = 'flex';
      }
    });

    adminLoginBtnEl.addEventListener('click', () => {
      const pw = adminPasswordEl.value;
      if (pw === ADMIN_PASSWORD) {
        adminBodyEl.style.display = 'block';
        alert('ê´€ë¦¬ì ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } else {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      }
    });

    resetVotesBtnEl.addEventListener('click', () => {
      if (!currentQuestionId) return;
      if (!confirm('í˜„ì¬ ì§ˆë¬¸ì˜ íˆ¬í‘œ ê¸°ë¡(ê¸°ê¸° ê¸°ë¡ í¬í•¨)ì„ ëª¨ë‘ ì´ˆê¸°í™”í• ê¹Œìš”?')) return;

      const updates = {};
      updates['votes/' + currentQuestionId] = null;
      updates['deviceVotes/' + currentQuestionId] = null;

      db.ref().update(updates).then(() => {
        alert('íˆ¬í‘œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
      });
    });

    hideNameBtnEl.addEventListener('click', () => {
      if (!currentQuestionId) return;
      const name = hideNameInputEl.value.trim();
      if (!name) {
        alert('ìˆ¨ê¸¸ ì´ë¦„/ë‹‰ë„¤ì„ì„ ì…ë ¥í•˜ì„¸ìš”.');
        return;
      }
      db.ref('hiddenNames/' + currentQuestionId + '/' + name).set(true);
      hideNameInputEl.value = '';
    });

    clearQuestionBtnEl.addEventListener('click', () => {
      if (!currentQuestionId) return;
      const q = questions.find(item => item.id === currentQuestionId);
      if (!q) return;

      if (!confirm(`"${q.title}" ì§ˆë¬¸ê³¼ í•´ë‹¹ ì§ˆë¬¸ì˜ ëª¨ë“  íˆ¬í‘œë¥¼ ì‚­ì œí• ê¹Œìš”?`)) return;

      const updates = {};
      updates['questions/' + currentQuestionId + '/active'] = false;
      updates['votes/' + currentQuestionId] = null;
      updates['hiddenNames/' + currentQuestionId] = null;
      updates['deviceVotes/' + currentQuestionId] = null;

      db.ref().update(updates).then(() => {
        questions = questions.filter(item => item.id !== currentQuestionId);
        if (questions.length === 0) {
          currentQuestionId = null;
          questionListEl.innerHTML = '';
          rankingListEl.innerHTML = '';
          rankingEmptyEl.style.display = 'block';
          cardTagEl.textContent = '';
          cardTitleEl.textContent = 'ì§ˆë¬¸ ì—†ìŒ';
          cardDescEl.textContent = 'í™œì„±í™”ëœ ì§ˆë¬¸ì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ì„œ ì§ˆë¬¸ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.';
          totalVotesEl.textContent = '0';
        } else {
          currentQuestionId = questions[0].id;
          switchQuestion(currentQuestionId);
        }
      });
    });

    // ==============================
    // 7. ê²Œì‹œíŒ (ê²Œì‹œê¸€ + ë‹µê¸€ + ì´ë¯¸ì§€ base64)
    // ==============================
    const letterAnonEl = document.getElementById('letter-anon');
    const letterNameEl = document.getElementById('letter-name');
    const letterMessageEl = document.getElementById('letter-message');
    const letterImageEl = document.getElementById('letter-image');
    const letterFormEl = document.getElementById('letter-form');
    const letterListEl = document.getElementById('letter-list');
    const letterEmptyEl = document.getElementById('letter-empty');

    let letters = [];
    let repliesData = {};

    letterAnonEl.addEventListener('change', () => {
      if (letterAnonEl.checked) {
        letterNameEl.disabled = true;
        letterNameEl.value = '';
      } else {
        letterNameEl.disabled = false;
      }
    });

    function readFileAsDataURL(file) {
      return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.onload = e => resolve(e.target.result);
        reader.onerror = e => reject(e);
        reader.readAsDataURL(file);
      });
    }

    letterFormEl.addEventListener('submit', async (e) => {
      e.preventDefault();
      const isAnonymous = letterAnonEl.checked;
      const nameInput = letterNameEl.value.trim();
      const message = letterMessageEl.value.trim();
      const file = letterImageEl.files[0];

      if (!message) {
        alert('ê²Œì‹œê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }
      if (!isAnonymous && !nameInput) {
        alert('ìµëª…ì´ ì•„ë‹ˆë¼ë©´ ì‹¤ëª… ë˜ëŠ” ë³„ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }

      const displayName = isAnonymous ? 'ìµëª…' : nameInput;

      try {
        const newRef = db.ref('letters').push();

        let imageData = null;
        if (file) {
          imageData = await readFileAsDataURL(file);
        }

        await newRef.set({
          name: displayName,
          isAnonymous: isAnonymous,
          rawName: nameInput || null,
          message: message,
          imageData: imageData,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        });

        letterMessageEl.value = '';
        letterImageEl.value = '';
        if (!isAnonymous) letterNameEl.value = '';
        alert('ê²Œì‹œê¸€ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
      } catch (err) {
        console.error(err);
        alert('ê²Œì‹œê¸€ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      }
    });

    const lettersRef = db.ref('letters').limitToLast(50);
    const repliesRootRef = db.ref('letterReplies');

    lettersRef.on('value', snapshot => {
      const val = snapshot.val();
      if (!val) {
        letters = [];
        renderLetters();
        return;
      }
      letters = Object.entries(val).map(([id, data]) => ({
        id,
        ...data
      }));
      letters.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      renderLetters();
    });

    repliesRootRef.on('value', snapshot => {
      repliesData = snapshot.val() || {};
      renderLetters();
    });

    function renderLetters() {
      letterListEl.innerHTML = '';

      if (!letters || letters.length === 0) {
        letterEmptyEl.style.display = 'block';
        return;
      }
      letterEmptyEl.style.display = 'none';

      letters.forEach(item => {
        const div = document.createElement('div');
        div.className = 'letter-item';

        const created = item.createdAt ? new Date(item.createdAt) : null;
        const timeStr = created ? created.toLocaleString('ko-KR') : '';

        const letterId = item.id;
        const letterReplies = (repliesData && repliesData[letterId]) || {};

        const replyArr = Object.entries(letterReplies).map(([rid, r]) => ({
          id: rid,
          ...r
        })).sort((a, b) => (a.createdAt || 0) - (b.createdAt || 0));

        let repliesHtml = '';
        replyArr.forEach(r => {
          const rCreated = r.createdAt ? new Date(r.createdAt) : null;
          const rTimeStr = rCreated ? rCreated.toLocaleString('ko-KR') : '';
          const rName = r.name || 'ìµëª…';
          repliesHtml += `
            <div class="reply-item">
              <div class="reply-bubble">
                <div class="reply-meta">${escapeHtml(rName)} Â· ${rTimeStr}</div>
                <div class="reply-message">${escapeHtml(r.message || '')}</div>
              </div>
            </div>
          `;
        });

        const imagePart = item.imageData
          ? `<img class="letter-image" src="${item.imageData}" alt="ì²¨ë¶€ ì´ë¯¸ì§€">`
          : '';

        div.innerHTML = `
          <div class="letter-header">
            <div>
              <span class="letter-name">${escapeHtml(item.name || 'ìµëª…')}</span>
              ${item.isAnonymous ? '<span class="letter-tag">ìµëª…</span>' : '<span class="letter-tag">ì‹¤ëª…/ë‹‰ë„¤ì„</span>'}
            </div>
            <div class="letter-time">${timeStr}</div>
          </div>
          <div class="letter-bubble">
            <div class="letter-message">${escapeHtml(item.message || '')}</div>
            ${imagePart}
          </div>
          <div class="reply-list" data-letter-id="${letterId}">
            ${repliesHtml}
          </div>
          <button class="reply-toggle" data-letter-id="${letterId}">ë‹µê¸€ ë‹¬ê¸°</button>
          <form class="reply-form hidden" data-letter-id="${letterId}">
            <div class="reply-form-row">
              <label style="display:flex;align-items:center;gap:4px;">
                <input type="checkbox" class="reply-anon" checked>
                ìµëª…
              </label>
            </div>
            <div class="reply-form-row">
              <input type="text" class="reply-name" placeholder="ì‹¤ëª…/ë³„ëª… (ìµëª…ì´ ì•„ë‹ˆë©´ í•„ìˆ˜)" disabled>
            </div>
            <textarea class="reply-message-input" placeholder="ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”."></textarea>
            <button type="submit">ë‹µê¸€ ë“±ë¡</button>
          </form>
        `;

        letterListEl.appendChild(div);

        const replyToggleBtn = div.querySelector('.reply-toggle');
        const replyFormEl = div.querySelector('.reply-form');
        const replyAnonEl = replyFormEl.querySelector('.reply-anon');
        const replyNameEl = replyFormEl.querySelector('.reply-name');
        const replyMsgEl = replyFormEl.querySelector('.reply-message-input');

        replyToggleBtn.addEventListener('click', () => {
          replyFormEl.classList.toggle('hidden');
        });

        replyAnonEl.addEventListener('change', () => {
          if (replyAnonEl.checked) {
            replyNameEl.disabled = true;
            replyNameEl.value = '';
          } else {
            replyNameEl.disabled = false;
          }
        });

        replyFormEl.addEventListener('submit', (e) => {
          e.preventDefault();
          const isAnon = replyAnonEl.checked;
          const nameVal = replyNameEl.value.trim();
          const msgVal = replyMsgEl.value.trim();
          if (!msgVal) {
            alert('ë‹µê¸€ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            return;
          }
          if (!isAnon && !nameVal) {
            alert('ìµëª…ì´ ì•„ë‹ˆë¼ë©´ ì´ë¦„ ë˜ëŠ” ë³„ëª…ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
            return;
          }
          const displayName = isAnon ? 'ìµëª…' : nameVal;
          const ref = db.ref('letterReplies/' + letterId).push();
          ref.set({
            name: displayName,
            isAnonymous: isAnon,
            rawName: nameVal || null,
            message: msgVal,
            createdAt: firebase.database.ServerValue.TIMESTAMP
          }).then(() => {
            replyMsgEl.value = '';
            if (!isAnon) replyNameEl.value = '';
          }).catch(err => {
            console.error(err);
            alert('ë‹µê¸€ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          });
        });
      });
    }

    function escapeHtml(str) {
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;');
    }

    // ==============================
    // 8. ì²­ìš´ìš°ì²´í†µ (í•œ ê¸°ê¸° 1íšŒ ì œí•œ)
    // ==============================
    const cheongunInfoTextEl = document.getElementById('cheongun-info-text');
    const cheongunFormEl = document.getElementById('cheongun-form');
    const cheongunFromEl = document.getElementById('cheongun-from');
    const cheongunToEl = document.getElementById('cheongun-to');
    const cheongunMessageEl = document.getElementById('cheongun-message');
    const cheongunSubmitBtnEl = document.getElementById('cheongun-submit-btn');

    function setCheongunDisabled(disabled) {
      cheongunFromEl.disabled = disabled;
      cheongunToEl.disabled = disabled;
      cheongunMessageEl.disabled = disabled;
      cheongunSubmitBtnEl.disabled = disabled;
    }

    function initCheongun() {
      const ref = db.ref('cheongunDevice/' + deviceId);
      ref.once('value').then(snapshot => {
        if (snapshot.exists()) {
          setCheongunDisabled(true);
          cheongunInfoTextEl.innerHTML =
            'ì²­ìš´ìš°ì²´í†µì€ <b>í‰ì†Œ ì „í•˜ì§€ ëª»í–ˆë˜ ë§ˆìŒì„ ë”± í•œ ì‚¬ëŒì—ê²Œë§Œ</b> ì „í•˜ëŠ” í¸ì§€í•¨ì…ë‹ˆë‹¤.<br>' +
            'ì´ ê¸°ê¸°ì—ì„œëŠ” ì´ë¯¸ í•œ ë²ˆ í¸ì§€ë¥¼ ë³´ëƒˆê¸° ë•Œë¬¸ì—, ë” ì´ìƒ ìƒˆë¡œìš´ í¸ì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.<br>' +
            '<b>ì‘ì„±ëœ í¸ì§€ëŠ” ê´€ë¦¬ìê°€ ë°›ì•„ì„œ, ë‚˜ì¤‘ì— ì‹¤ì œë¡œ í¸ì§€ë¡œ ì „ë‹¬í•  ì˜ˆì •ì…ë‹ˆë‹¤.</b>';
        }
      });
    }

    cheongunFormEl.addEventListener('submit', (e) => {
      e.preventDefault();
      const fromName = cheongunFromEl.value.trim();
      const toName = cheongunToEl.value.trim();
      const message = cheongunMessageEl.value.trim();

      if (!toName) {
        alert('ë°›ëŠ” ì‚¬ëŒì„ ì…ë ¥í•´ ì£¼ì„¸ìš”. (í•™ë²ˆ+ì´ë¦„ ë˜ëŠ” ë‹‰ë„¤ì„)');
        return;
      }
      if (!message) {
        alert('í¸ì§€ ë‚´ìš©ì„ ì…ë ¥í•´ ì£¼ì„¸ìš”.');
        return;
      }

      const deviceRef = db.ref('cheongunDevice/' + deviceId);
      deviceRef.once('value').then(snapshot => {
        if (snapshot.exists()) {
          alert('ì´ ê¸°ê¸°ì—ì„œëŠ” ì´ë¯¸ ì²­ìš´ìš°ì²´í†µì„ í•œ ë²ˆ ë³´ëƒˆìŠµë‹ˆë‹¤.');
          setCheongunDisabled(true);
          return;
        }

        const newRef = db.ref('cheongunLetters').push();
        const letterId = newRef.key;

        const payload = {
          fromName: fromName || null,
          toName: toName,
          message: message,
          deviceId: deviceId,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };

        const updates = {};
        updates['cheongunLetters/' + letterId] = payload;
        updates['cheongunDevice/' + deviceId] = letterId;

        db.ref().update(updates).then(() => {
          alert('ì²­ìš´ìš°ì²´í†µì— í¸ì§€ê°€ ì ‘ìˆ˜ë˜ì—ˆìŠµë‹ˆë‹¤. ë‚˜ì¤‘ì— ì˜¤í”„ë¼ì¸ì—ì„œ ì‹¤ì œë¡œ ì „ë‹¬ë  ì˜ˆì •ì…ë‹ˆë‹¤.');
          setCheongunDisabled(true);
          cheongunMessageEl.value = '';
          cheongunFromEl.value = '';
          cheongunToEl.value = '';
          cheongunInfoTextEl.innerHTML =
            'ì²­ìš´ìš°ì²´í†µì€ <b>í‰ì†Œ ìš©ê¸° ë‚´ì„œ ë§í•˜ì§€ ëª»í–ˆë˜ ë§ˆìŒì„ ë”± í•œ ì‚¬ëŒì—ê²Œë§Œ</b> ì „í•˜ëŠ” í¸ì§€í•¨ì…ë‹ˆë‹¤!<br>' +
            'ì´ë¯¸ ì´ ê¸°ê¸°ì—ì„œ í•œ ë²ˆ í¸ì§€ë¥¼ ë³´ëƒˆìŠµë‹ˆë‹¤. ë‘ ë²ˆì§¸ í¸ì§€ëŠ” ì“¸ ìˆ˜ ì—†ì–´ìš”.<br>' +
            '<b>ì‘ì„±ëœ í¸ì§€ëŠ” ê´€ë¦¬ìê°€ ë°›ì•„ì„œ, ë‚˜ì¤‘ì— ì‹¤ì œë¡œ ì „ë‹¬í•´ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.</b>';
        }).catch(err => {
          console.error(err);
          alert('í¸ì§€ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        });
      });
    });

    // ==============================
    // 9. ì‹œì‘
    // ==============================
    initQuestionsFromFirebase();
    initCheongun();
  </script>
</body>
</html>

